<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - ChrisShop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/animations.css" rel="stylesheet">
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container py-5">
        <div class="row">
            <div class="col-12">
                <h1 class="fw-bold mb-4">Mi Carrito de Compras</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <% if (typeof cartItems !== 'undefined' && cartItems.length > 0) { %>
                    <div class="cart-items">
                        <% cartItems.forEach(item => { %>
                        <% 
                            // Asegurar que el precio sea un número
                            const precio = Number(item.precio) || 0;
                            const itemTotal = precio * item.cantidad;
                        %>
                        <div class="cart-item mb-4" data-item-id="<%= item.id %>" data-product-id="<%= item.producto_id %>" data-price="<%= precio %>">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <img src="<%= item.imagen %>" alt="<%= item.nombre %>" 
                                         class="img-fluid rounded" 
                                         onerror="this.src='https://via.placeholder.com/100x100/2a2a3c/ffffff?text=Producto'">
                                </div>
                                <div class="col-md-4">
                                    <h5 class="mb-1"><%= item.nombre %></h5>
                                    <p class="text-muted mb-0"><%= item.marca %></p>
                                    <small class="text-success">
                                        <i class="fas fa-box me-1"></i>
                                        <%= item.stock %> disponibles
                                    </small>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-outline-secondary quantity-btn decrease" 
                                                data-item-id="<%= item.id %>">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="number" class="form-control quantity-input mx-2 text-center" 
                                               value="<%= item.cantidad %>" min="1" max="<%= item.stock %>"
                                               data-item-id="<%= item.id %>">
                                        <button class="btn btn-outline-secondary quantity-btn increase" 
                                                data-item-id="<%= item.id %>">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <h5 class="text-primary mb-0 item-total">
                                        $<%= itemTotal.toFixed(2) %>
                                    </h5>
                                    <small class="text-muted">$<%= precio.toFixed(2) %> c/u</small>
                                </div>
                                <div class="col-md-1">
                                    <button class="btn btn-danger btn-sm remove-btn" 
                                            data-item-id="<%= item.id %>">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <% }); %>
                    </div>
                <% } else { %>
                    <div class="text-center py-5">
                        <i class="fas fa-shopping-cart fa-5x text-muted mb-3"></i>
                        <h3 class="text-muted">Tu carrito está vacío</h3>
                        <p class="text-muted">Agrega algunos productos increíbles a tu carrito</p>
                        <a href="/products" class="btn btn-primary mt-3">
                            <i class="fas fa-gamepad me-2"></i>Explorar Productos
                        </a>
                    </div>
                <% } %>
            </div>

            <% if (typeof cartItems !== 'undefined' && cartItems.length > 0) { %>
            <div class="col-lg-4">
                <div class="total-section p-4">
                    <h4 class="fw-bold mb-4">Resumen del Pedido</h4>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span>Subtotal:</span>
                        <span id="subtotal">$<%= typeof total === 'number' ? total.toFixed(2) : '0.00' %></span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span>Envío:</span>
                        <span id="shipping">$0.00</span>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-4">
                        <strong>Total:</strong>
                        <strong id="total-amount">$<%= typeof total === 'number' ? total.toFixed(2) : '0.00' %></strong>
                    </div>
                    
                    <button class="btn btn-primary w-100 py-2 mb-3" onclick="proceedToCheckout()">
                        <i class="fas fa-credit-card me-2"></i>Proceder al Pago
                    </button>
                    
                    <a href="/products" class="btn btn-outline-light w-100">
                        <i class="fas fa-arrow-left me-2"></i>Seguir Comprando
                    </a>
                </div>
            </div>
            <% } %>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Esperar a que el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners para los botones de cantidad
            document.querySelectorAll('.quantity-btn.decrease').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-item-id');
                    updateQuantity(itemId, -1);
                });
            });

            document.querySelectorAll('.quantity-btn.increase').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-item-id');
                    updateQuantity(itemId, 1);
                });
            });

            // Event listeners para los inputs de cantidad
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', function() {
                    const itemId = this.getAttribute('data-item-id');
                    updateQuantityDirect(itemId, this.value);
                });
            });

            // Event listeners para los botones de eliminar
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-item-id');
                    removeFromCart(itemId);
                });
            });
        });

        // Función para actualizar cantidad
        function updateQuantity(itemId, change) {
            const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
            if (!input) {
                console.error('No se encontró el input para el item:', itemId);
                return;
            }

            let newQuantity = parseInt(input.value) + change;
            
            if (newQuantity < 1) newQuantity = 1;
            if (newQuantity > parseInt(input.max)) {
                newQuantity = parseInt(input.max);
                showNotification('No hay más stock disponible', 'warning');
            }
            
            input.value = newQuantity;
            updateCartItem(itemId, newQuantity);
        }

        // Función para actualizar cantidad directa
        function updateQuantityDirect(itemId, quantity) {
            if (quantity < 1) quantity = 1;
            const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
            if (input && quantity > parseInt(input.max)) {
                quantity = parseInt(input.max);
                showNotification('No hay más stock disponible', 'warning');
            }
            updateCartItem(itemId, parseInt(quantity));
        }

        // Función para actualizar item en el carrito
        function updateCartItem(itemId, quantity) {
            showNotification('Actualizando cantidad...', 'info');
            
            fetch(`/cart/update/${itemId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ quantity: quantity })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Cantidad actualizada correctamente', 'success');
                    // Recargar la página para ver los cambios actualizados
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showNotification('Error al actualizar: ' + (data.error || 'Error desconocido'), 'danger');
                    // Recargar para obtener el estado actual
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error de conexión', 'danger');
            });
        }

        // Función para eliminar del carrito
        function removeFromCart(itemId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este producto del carrito?')) {
                return;
            }

            showNotification('Eliminando producto...', 'info');

            fetch(`/cart/remove/${itemId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Producto eliminado del carrito', 'success');
                    // Actualizar contador del carrito
                    updateCartCounter(data.cartCount);
                    // Eliminar el elemento del DOM
                    const cartItem = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
                    if (cartItem) {
                        cartItem.style.opacity = '0';
                        cartItem.style.transform = 'translateX(100px)';
                        setTimeout(() => {
                            cartItem.remove();
                            // Si no quedan items, recargar la página
                            if (document.querySelectorAll('.cart-item').length === 0) {
                                location.reload();
                            }
                        }, 500);
                    } else {
                        // Si no se encuentra el elemento, recargar la página
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                } else {
                    showNotification('Error al eliminar: ' + (data.error || 'Error desconocido'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error de conexión', 'danger');
            });
        }

        // Función para actualizar contador del carrito
        function updateCartCounter(count) {
            const cartCounter = document.querySelector('.navbar .badge.bg-primary');
            if (cartCounter) {
                cartCounter.textContent = count;
                // Animación
                cartCounter.style.transform = 'scale(1.5)';
                setTimeout(() => {
                    cartCounter.style.transform = 'scale(1)';
                }, 300);
            }
        }

        // Función para proceder al pago
        function proceedToCheckout() {
            window.location.href = '/orders/checkout';
        }

        // Mostrar notificación
        function showNotification(message, type = 'success') {
            // Remover notificaciones existentes
            document.querySelectorAll('.custom-notification').forEach(notification => {
                notification.remove();
            });

            const notification = document.createElement('div');
            notification.className = `custom-notification alert alert-${type} position-fixed`;
            notification.style.cssText = `
                top: 20px; 
                right: 20px; 
                z-index: 9999; 
                min-width: 300px;
                transition: all 0.3s ease;
            `;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'info' ? 'info-circle' : 'exclamation-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
    </script>
</body>
</html>